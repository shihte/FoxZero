<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FoxZero ç®—ç‰Œå™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        anthropic: {
                            dark: '#141413', light: '#faf9f5', mid: '#b0aea5',
                            lightgray: '#e8e6dc', orange: '#d97757',
                            blue: '#6a9bcc', green: '#788c5d', hoverorange: '#c26547'
                        }
                    },
                    fontFamily: {
                        heading: ['Poppins', 'Arial', 'sans-serif'],
                        body: ['Lora', 'Georgia', 'serif']
                    }
                }
            }
        }
    </script>
    <link
        href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,600;1,400&family=Poppins:wght@400;600;700&display=swap"
        rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/wnumb/1.2.0/wNumb.min.js"></script>

    <style>
        body {
            background-color: #faf9f5;
            color: #141413;
            font-family: 'Lora', Georgia, serif;
        }

        h1,
        h2,
        h3,
        h4,
        .heading-font {
            font-family: 'Poppins', Arial, sans-serif;
        }

        .noUi-target {
            background: #e8e6dc;
            border-radius: 99px;
            border: none;
            box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.1);
        }

        .noUi-handle {
            /* Larger handle = easier to grab */
            width: 22px !important;
            height: 22px !important;
            right: -11px !important;
            top: -10px !important;
            background: #fff;
            border-radius: 50%;
            border: 2.5px solid #141413;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
            cursor: grab;
            transition: box-shadow 0.15s ease, transform 0.1s ease;
        }

        .noUi-handle:hover {
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.22);
            transform: scale(1.12);
        }

        .noUi-handle:active {
            cursor: grabbing;
            transform: scale(1.18);
        }

        .noUi-handle:before,
        .noUi-handle:after {
            display: none;
        }

        .noUi-handle.focus-top {
            z-index: 10 !important;
        }

        /* Extra horizontal & vertical room so edge handles aren't clipped or overlap */
        .slider-wrap {
            padding: 0 6px;
            margin: 18px 0 12px 0;
        }

        .color-spade .noUi-connect {
            background: #141413;
        }

        .color-heart .noUi-connect {
            background: #d97757;
        }

        .color-club .noUi-connect {
            background: #788c5d;
        }

        .color-diamond .noUi-connect {
            background: #6a9bcc;
        }

        /* Dimmed/disabled slider */
        .noUi-target[disabled] {
            opacity: 0.35;
            pointer-events: none;
            filter: grayscale(1);
        }

        /* Card Checkboxes */
        .card-checkbox {
            display: none;
        }

        .card-label-btn {
            background: white;
            border: 1px solid #e8e6dc;
            border-radius: 8px;
            transition: background 0.15s ease, color 0.15s ease, border-color 0.15s ease;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .card-checkbox:checked+.card-label-btn {
            font-weight: 700;
        }

        /* Suit-specific selected state colors */
        .suit-s .card-checkbox:checked+.card-label-btn {
            background: #141413;
            color: white;
            border-color: #141413;
        }

        .suit-h .card-checkbox:checked+.card-label-btn {
            background: #d97757;
            color: white;
            border-color: #d97757;
        }

        .suit-c .card-checkbox:checked+.card-label-btn {
            background: #788c5d;
            color: white;
            border-color: #788c5d;
        }

        .suit-d .card-checkbox:checked+.card-label-btn {
            background: #6a9bcc;
            color: white;
            border-color: #6a9bcc;
        }

        .card-label-btn:hover {
            border-color: #b0aea5;
            background: #f7f5ef;
        }

        /* Suit label strip before card row */
        .suit-row-label {
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            font-size: 0.75rem;
            letter-spacing: 0.04em;
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 6px;
        }

        /* Compact toggle (circle) for suit disabled */
        .toggle-track {
            width: 36px;
            height: 20px;
            border-radius: 99px;
            background: #e8e6dc;
            cursor: pointer;
            position: relative;
            transition: background 0.2s ease;
            flex-shrink: 0;
        }

        .toggle-track::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease;
        }

        input.toggle-checkbox:checked+.toggle-track {
            background: #d97757;
        }

        input.toggle-checkbox:checked+.toggle-track::after {
            transform: translateX(16px);
        }

        input.toggle-checkbox {
            display: none;
        }
    </style>
</head>

<body class="min-h-screen py-10 px-4">
    <div class="max-w-3xl mx-auto space-y-8">

        <!-- ===== HEADER ===== -->
        <div class="text-center">
            <h1 class="text-4xl md:text-5xl font-bold text-anthropic-dark mb-2 tracking-tight">ğŸ¦Š FoxZero é‚è¼¯æ¨æ¼”ç®—ç‰Œå™¨</h1>
            <p class="text-anthropic-mid italic text-base">æ¡ç”¨ MCTS è‡ªæˆ‘å°å¼ˆæ¨æ¼”æ‚¨çš„æœ€ä½³æ­¥æ•¸</p>
        </div>

        <!-- ===== SECTION 1: æ¡Œé¢ç‹€æ…‹ ===== -->
        <div class="bg-white p-6 md:p-8 rounded-2xl shadow-sm border border-anthropic-lightgray">
            <h3 class="text-xl font-bold mb-1 heading-font text-anthropic-dark flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <rect x="2" y="7" width="20" height="14" rx="2" />
                    <path d="M16 7V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v2" />
                </svg>
                æ¡Œé¢ç‹€æ…‹
            </h3>
            <p class="text-xs text-anthropic-mid mb-6">è¨­å®šå„èŠ±è‰²å·²å‡ºçš„ç¯„åœã€‚å³å´çš„åˆ‡æ›é–‹é—œ = é—œæ‰ä»£è¡¨æ­¤èŠ±è‰²ã€Œå®Œå…¨æœªç ´å†°ã€ã€‚</p>

            <div class="space-y-12" id="slider-section">
                <!-- Spade -->
                <div>
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2">
                            <svg class="w-4 h-4 text-anthropic-dark" viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M12 2.75C12 2.75 3 10.25 3 14.5C3 18.5 7 20 10.5 19.5L11 22H13L13.5 19.5C17 20 21 18.5 21 14.5C21 10.25 12 2.75 12 2.75Z" />
                            </svg>
                            <span class="heading-font font-semibold text-sm">é»‘æ¡ƒ (Spade)</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <span id="s-val"
                                class="font-mono text-xs bg-anthropic-light px-2 py-0.5 rounded border border-anthropic-lightgray min-w-[62px] text-center">å‰›å‡º
                                7</span>
                            <label class="flex items-center gap-1.5 cursor-pointer select-none">
                                <input type="checkbox" id="not-started-s" class="toggle-checkbox">
                                <span class="toggle-track"></span>
                            </label>
                        </div>
                    </div>
                    <div id="slider-s" class="color-spade h-2 slider-wrap"></div>
                </div>

                <!-- Heart -->
                <div>
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2">
                            <svg class="w-4 h-4 text-anthropic-orange" viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M12 21.35L10.55 20.03C5.4 15.36 2 12.28 2 8.5C2 5.42 4.42 3 7.5 3C9.24 3 10.91 3.81 12 5.09C13.09 3.81 14.76 3 16.5 3C19.58 3 22 5.42 22 8.5C22 12.28 18.6 15.36 13.45 20.04L12 21.35Z" />
                            </svg>
                            <span class="heading-font font-semibold text-sm">ç´…å¿ƒ (Heart)</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <span id="h-val"
                                class="font-mono text-xs bg-anthropic-light px-2 py-0.5 rounded border border-anthropic-lightgray min-w-[62px] text-center">å‰›å‡º
                                7</span>
                            <label class="flex items-center gap-1.5 cursor-pointer select-none">
                                <input type="checkbox" id="not-started-h" class="toggle-checkbox" checked>
                                <span class="toggle-track"></span>
                            </label>
                        </div>
                    </div>
                    <div id="slider-h" class="color-heart h-2 slider-wrap"></div>
                </div>

                <!-- Club -->
                <div>
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2">
                            <svg class="w-4 h-4 text-anthropic-green" viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M12 2C9.24 2 7 4.24 7 7C7 8.54 7.69 9.89 8.78 10.82C6.67 11.23 5 13.11 5 15.4C5 17.94 7.06 20 9.6 20C10.74 20 11.78 19.59 12.6 18.91L11.5 22H12.5L11.4 18.91C12.22 19.59 13.26 20 14.4 20C16.94 20 19 17.94 19 15.4C19 13.11 17.33 11.23 15.22 10.82C16.31 9.89 17 8.54 17 7C17 4.24 14.76 2 12 2Z" />
                            </svg>
                            <span class="heading-font font-semibold text-sm">æ¢…èŠ± (Club)</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <span id="c-val"
                                class="font-mono text-xs bg-anthropic-light px-2 py-0.5 rounded border border-anthropic-lightgray min-w-[62px] text-center">å‰›å‡º
                                7</span>
                            <label class="flex items-center gap-1.5 cursor-pointer select-none">
                                <input type="checkbox" id="not-started-c" class="toggle-checkbox" checked>
                                <span class="toggle-track"></span>
                            </label>
                        </div>
                    </div>
                    <div id="slider-c" class="color-club h-2 slider-wrap"></div>
                </div>

                <!-- Diamond -->
                <div>
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2">
                            <svg class="w-4 h-4 text-anthropic-blue" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2L2 12L12 22L22 12L12 2Z" />
                            </svg>
                            <span class="heading-font font-semibold text-sm">æ–¹å¡Š (Diamond)</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <span id="d-val"
                                class="font-mono text-xs bg-anthropic-light px-2 py-0.5 rounded border border-anthropic-lightgray min-w-[62px] text-center">å‰›å‡º
                                7</span>
                            <label class="flex items-center gap-1.5 cursor-pointer select-none">
                                <input type="checkbox" id="not-started-d" class="toggle-checkbox" checked>
                                <span class="toggle-track"></span>
                            </label>
                        </div>
                    </div>
                    <div id="slider-d" class="color-diamond h-2 slider-wrap"></div>
                </div>
            </div>
        </div>

        <!-- ===== SECTION 2: æ¨æ¼”è¨­å®š ===== -->
        <div class="bg-white p-6 md:p-8 rounded-2xl shadow-sm border border-anthropic-lightgray">
            <h3 class="text-xl font-bold mb-6 heading-font text-anthropic-dark flex items-center gap-2">
                <svg class="w-5 h-5 text-anthropic-orange" fill="none" stroke="currentColor" stroke-width="2"
                    viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                æ¨æ¼”è¨­å®š
            </h3>

            <!-- ç©å®¶è“‹ç‰Œæ•¸ â€” æ©«å‘ 4 æ ¼ -->
            <p class="text-xs text-anthropic-mid mb-3 font-heading font-semibold tracking-wide uppercase">ç©å®¶è“‹ç‰Œæ•¸</p>
            <div class="grid grid-cols-4 gap-3 mb-8">
                <div>
                    <label class="block text-xs text-center font-heading font-semibold text-anthropic-dark mb-1">æˆ‘
                        (P1)</label>
                    <input type="number" id="cp1" value="0" min="0" max="13"
                        class="w-full px-2 py-2 bg-anthropic-light border border-anthropic-lightgray rounded-lg text-center text-sm focus:outline-none focus:ring-2 focus:ring-anthropic-orange transition">
                </div>
                <div>
                    <label
                        class="block text-xs text-center font-heading font-semibold text-anthropic-dark mb-1">P2</label>
                    <input type="number" id="cp2" value="0" min="0" max="13"
                        class="w-full px-2 py-2 bg-anthropic-light border border-anthropic-lightgray rounded-lg text-center text-sm focus:outline-none focus:ring-2 focus:ring-anthropic-orange transition">
                </div>
                <div>
                    <label
                        class="block text-xs text-center font-heading font-semibold text-anthropic-dark mb-1">P3</label>
                    <input type="number" id="cp3" value="0" min="0" max="13"
                        class="w-full px-2 py-2 bg-anthropic-light border border-anthropic-lightgray rounded-lg text-center text-sm focus:outline-none focus:ring-2 focus:ring-anthropic-orange transition">
                </div>
                <div>
                    <label
                        class="block text-xs text-center font-heading font-semibold text-anthropic-dark mb-1">P4</label>
                    <input type="number" id="cp4" value="0" min="0" max="13"
                        class="w-full px-2 py-2 bg-anthropic-light border border-anthropic-lightgray rounded-lg text-center text-sm focus:outline-none focus:ring-2 focus:ring-anthropic-orange transition">
                </div>
            </div>

            <!-- æ¨æ¼”æ·±åº¦ -->
            <div>
                <div
                    class="flex justify-between items-center heading-font text-sm font-semibold text-anthropic-dark mb-3">
                    <span>æ¨æ¼”æ·±åº¦ (Simulations)</span>
                    <span id="sim-val" class="font-mono bg-anthropic-lightgray px-3 py-0.5 rounded text-sm">2000</span>
                </div>
                <input type="range" id="sims" min="100" max="5000" step="100" value="2000"
                    class="w-full h-2 rounded-lg appearance-none cursor-pointer accent-anthropic-orange bg-anthropic-lightgray">
            </div>
        </div>

        <!-- ===== SECTION 3: æˆ‘çš„æ‰‹ç‰Œ ===== -->
        <div class="bg-white p-6 md:p-8 rounded-2xl shadow-sm border border-anthropic-lightgray">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold heading-font text-anthropic-dark flex items-center gap-2">
                    <svg class="w-5 h-5 text-anthropic-blue" fill="none" stroke="currentColor" stroke-width="2"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M7 11.5V14m0-2.5v-6a1.5 1.5 0 113 0m-3 6a1.5 1.5 0 00-3 0v2a7.5 7.5 0 0015 0v-5a1.5 1.5 0 00-3 0m-6-3V11m0-5.5v-1a1.5 1.5 0 013 0v1m0 0V11m0-5.5a1.5 1.5 0 013 0v3m0 0V11" />
                    </svg>
                    æˆ‘çš„æ‰‹ç‰Œ
                </h3>
                <button id="clear-hand-btn"
                    class="font-heading text-xs font-semibold px-4 py-2 bg-anthropic-lightgray text-anthropic-dark hover:bg-anthropic-mid hover:text-white rounded-lg transition-colors">
                    æ¸…ç©º
                </button>
            </div>
            <div id="hand-selection-area" class="flex flex-col gap-5">
                <!-- Built by JS -->
            </div>
        </div>

        <!-- ===== RUN BUTTON ===== -->
        <button onclick="runAnalysis()" id="run-btn"
            class="w-full py-5 bg-anthropic-orange text-white font-heading font-bold text-xl rounded-2xl shadow-lg hover:bg-anthropic-hoverorange hover:shadow-xl transform hover:-translate-y-1 transition-all duration-200 focus:outline-none focus:ring-4 focus:ring-anthropic-orange/40">
            ğŸš€ é–‹å§‹æ¨æ¼”
        </button>

        <!-- ===== OUTPUT ===== -->
        <div id="result-section"
            class="bg-anthropic-dark text-anthropic-light p-6 md:p-8 rounded-2xl shadow-xl hidden border border-gray-800">
            <h3 class="text-xl font-bold mb-4 heading-font flex items-center gap-2">
                <svg class="w-5 h-5 text-anthropic-blue" fill="none" stroke="currentColor" stroke-width="2"
                    viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
                æ¨æ¼”çµè«–
            </h3>

            <!-- AI Suggestion Card Area -->
            <div id="suggestion-card-area"
                class="hidden mb-6 flex flex-col md:flex-row items-center gap-6 bg-black/30 p-5 rounded-xl border border-gray-700">
                <div id="suggestion-badge"
                    class="px-3 py-1 text-sm font-bold rounded-full bg-white text-black mb-3 md:mb-0 heading-font">å‡ºç‰Œ
                </div>
                <div id="suggestion-visual"
                    class="flex items-center justify-center w-24 h-32 bg-white rounded-xl shadow-inner border-2 text-3xl font-bold font-mono">
                    <span id="suggestion-suit-icon" class="mr-1"></span>
                    <span id="suggestion-rank-text" class="text-anthropic-dark"></span>
                </div>
                <div class="flex-1 flex flex-col gap-3 w-full md:w-auto mt-4 md:mt-0">
                    <button id="apply-btn"
                        class="w-full py-3 bg-anthropic-blue hover:bg-blue-600 text-white font-bold rounded-xl transition-colors shadow flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7">
                            </path>
                        </svg>
                        å¥—ç”¨æ­¤å»ºè­°
                    </button>
                    <p class="text-xs text-gray-400 text-center">è‡ªå‹•æ›´æ–°æ¡Œé¢ç‹€æ…‹èˆ‡æ‚¨çš„æ‰‹ç‰Œ</p>
                </div>
            </div>

            <pre id="result-output"
                class="font-mono text-sm leading-relaxed whitespace-pre-wrap overflow-x-auto p-4 bg-black/40 rounded-xl border border-gray-700/50">ç­‰å¾…æ¨æ¼”å®Œæˆ...</pre>
        </div>

    </div>

    <script>
        const suits = [
            { id: 's', name: 'Spade', color: '#141413' },
            { id: 'h', name: 'Heart', color: '#d97757' },
            { id: 'c', name: 'Club', color: '#788c5d' },
            { id: 'd', name: 'Diamond', color: '#6a9bcc' }
        ];

        const suitNameZh = { s: 'é»‘æ¡ƒ', h: 'ç´…å¿ƒ', c: 'æ¢…èŠ±', d: 'æ–¹å¡Š' };
        const suitSymbolSVG = {
            s: `<svg class="w-3.5 h-3.5 inline-block mr-1" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.75C12 2.75 3 10.25 3 14.5C3 18.5 7 20 10.5 19.5L11 22H13L13.5 19.5C17 20 21 18.5 21 14.5C21 10.25 12 2.75 12 2.75Z"/></svg>`,
            h: `<svg class="w-3.5 h-3.5 inline-block mr-1" viewBox="0 0 24 24" fill="currentColor"><path d="M12 21.35L10.55 20.03C5.4 15.36 2 12.28 2 8.5C2 5.42 4.42 3 7.5 3C9.24 3 10.91 3.81 12 5.09C13.09 3.81 14.76 3 16.5 3C19.58 3 22 5.42 22 8.5C22 12.28 18.6 15.36 13.45 20.04L12 21.35Z"/></svg>`,
            c: `<svg class="w-3.5 h-3.5 inline-block mr-1" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C9.24 2 7 4.24 7 7C7 8.54 7.69 9.89 8.78 10.82C6.67 11.23 5 13.11 5 15.4C5 17.94 7.06 20 9.6 20C10.74 20 11.78 19.59 12.6 18.91L11.5 22H12.5L11.4 18.91C12.22 19.59 13.26 20 14.4 20C16.94 20 19 17.94 19 15.4C19 13.11 17.33 11.23 15.22 10.82C16.31 9.89 17 8.54 17 7C17 4.24 14.76 2 12 2Z"/></svg>`,
            d: `<svg class="w-3.5 h-3.5 inline-block mr-1" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L2 12L12 22L22 12L12 2Z"/></svg>`
        };

        // --- Sliders ---
        suits.forEach(s => {
            const slider = document.getElementById(`slider-${s.id}`);
            const toggle = document.getElementById(`not-started-${s.id}`);
            const valEl = document.getElementById(`${s.id}-val`);

            noUiSlider.create(slider, {
                start: [7, 7], connect: true, step: 1,
                range: { min: 1, max: 13 },
                behavior: 'drag-tap',
                pips: { mode: 'values', values: [1, 7, 13], density: 4, format: wNumb({ decimals: 0 }) }
            });

            // --- Smart Z-index fix ---
            // Listen on the SLIDER CONTAINER (before noUiSlider eats the event)
            // and promote whichever handle is closer to the click X.
            const promoteNearestHandle = (clientX) => {
                const rect = slider.getBoundingClientRect();
                const clickPct = (clientX - rect.left) / rect.width; // 0..1
                const vals = slider.noUiSlider.get().map(Number);
                const range = 13 - 1; // max - min
                const pct0 = (vals[0] - 1) / range;
                const pct1 = (vals[1] - 1) / range;
                const handles = slider.querySelectorAll('.noUi-handle');
                const d0 = Math.abs(clickPct - pct0);
                const d1 = Math.abs(clickPct - pct1);
                handles.forEach(h => h.classList.remove('focus-top'));
                // Promote the closer handle
                handles[d0 <= d1 ? 0 : 1].classList.add('focus-top');
            };

            slider.addEventListener('mousedown', e => promoteNearestHandle(e.clientX));
            slider.addEventListener('touchstart', e => {
                if (e.touches.length > 0) promoteNearestHandle(e.touches[0].clientX);
            }, { passive: true });

            slider.noUiSlider.on('update', vals => {
                const v1 = Math.round(vals[0]), v2 = Math.round(vals[1]);
                valEl.textContent = (v1 === 7 && v2 === 7) ? 'å‰›å‡º 7' : `${v1} â†” ${v2}`;
            });

            toggle.addEventListener('change', () => {
                if (toggle.checked) {
                    slider.setAttribute('disabled', true);
                    valEl.textContent = 'æœªç ´å†°';
                    valEl.classList.add('opacity-40');
                } else {
                    slider.removeAttribute('disabled');
                    valEl.classList.remove('opacity-40');
                    const [v1, v2] = slider.noUiSlider.get().map(x => Math.round(x));
                    valEl.textContent = (v1 === 7 && v2 === 7) ? 'å‰›å‡º 7' : `${v1} â†” ${v2}`;
                }
            });

            // Initialize disabled state if checked by default
            if (toggle.checked) {
                toggle.dispatchEvent(new Event('change'));
            }
        });

        // --- Hand Card Grid (with suit row label) ---
        const handArea = document.getElementById('hand-selection-area');
        const rankLabels = { 1: 'A', 11: 'J', 12: 'Q', 13: 'K' };

        suits.forEach(s => {
            const wrapper = document.createElement('div');

            // Suit label row
            const label = document.createElement('div');
            label.className = 'suit-row-label mb-2';
            label.style.color = s.color;
            label.innerHTML = suitSymbolSVG[s.id] + suitNameZh[s.id];
            wrapper.appendChild(label);

            // Horizontal scroll card strip
            const row = document.createElement('div');
            row.className = 'suit-' + s.id + ' flex flex-row gap-2 overflow-x-auto pb-1';
            row.style.scrollbarWidth = 'thin';

            for (let r = 1; r <= 13; r++) {
                const txt = rankLabels[r] || String(r);
                const id = `card-${s.id}-${r}`;
                const wrap = document.createElement('div');
                wrap.className = 'flex-shrink-0';
                const chk = document.createElement('input');
                chk.type = 'checkbox'; chk.id = id; chk.className = 'card-checkbox';
                const lbl = document.createElement('label');
                lbl.className = 'card-label-btn flex items-center justify-center w-10 py-2 font-mono text-sm';
                lbl.htmlFor = id; lbl.textContent = txt;
                wrap.appendChild(chk); wrap.appendChild(lbl); row.appendChild(wrap);
            }
            wrapper.appendChild(row);
            handArea.appendChild(wrapper);
        });

        // Sim slider label
        document.getElementById('sims').addEventListener('input', e =>
            document.getElementById('sim-val').textContent = e.target.value);

        // Clear hand
        document.getElementById('clear-hand-btn').addEventListener('click', () =>
            document.querySelectorAll('.card-checkbox').forEach(cb => cb.checked = false));

        // --- Run Analysis ---
        async function runAnalysis() {
            const btn = document.getElementById('run-btn');
            const resSec = document.getElementById('result-section');
            const resOut = document.getElementById('result-output');

            btn.disabled = true;
            btn.innerHTML = `<span class="inline-block w-5 h-5 border-[3px] border-white border-t-transparent rounded-full animate-spin mr-2 align-middle"></span><span class="align-middle">æ¨æ¼”é‹ç®—ä¸­...</span>`;
            resSec.classList.remove('hidden');
            resOut.textContent = 'æ­£åœ¨å»ºç«‹æ±ºç­–è’™åœ°å¡ç¾…æ¨¹ (MCTS)...';
            resSec.scrollIntoView({ behavior: 'smooth', block: 'start' });

            const data = {
                simulations: parseInt(document.getElementById('sims').value),
                covered: {
                    p1: parseInt(document.getElementById('cp1').value) || 0,
                    p2: parseInt(document.getElementById('cp2').value) || 0,
                    p3: parseInt(document.getElementById('cp3').value) || 0,
                    p4: parseInt(document.getElementById('cp4').value) || 0,
                },
                ranges: {},
                hand: []
            };

            suits.forEach(s => {
                if (document.getElementById(`not-started-${s.id}`).checked) {
                    data.ranges[s.id] = [];
                } else {
                    const vals = document.getElementById(`slider-${s.id}`).noUiSlider.get();
                    data.ranges[s.id] = [Math.round(vals[0]), Math.round(vals[1])];
                }
                for (let r = 1; r <= 13; r++) {
                    if (document.getElementById(`card-${s.id}-${r}`).checked)
                        data.hand.push(`${s.id.toUpperCase()}${r}`);
                }
            });

            try {
                const res = await fetch('/analyze', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const j = await res.json();

                const cardArea = document.getElementById('suggestion-card-area');

                if (j.error) {
                    resOut.innerHTML = `<span class="text-anthropic-orange font-bold">âš ï¸ æ¨æ¼”ä¸­æ–·:</span>\n${j.error}`;
                    cardArea.classList.add('hidden');
                } else if (j.output && j.output.action) {
                    const out = j.output;
                    cardArea.classList.remove('hidden');
                    cardArea.classList.add('flex');

                    const badge = document.getElementById('suggestion-badge');
                    const vis = document.getElementById('suggestion-visual');
                    const rankText = document.getElementById('suggestion-rank-text');
                    const suitIcon = document.getElementById('suggestion-suit-icon');

                    // Render card UI
                    if (out.is_play) {
                        badge.textContent = "âœ… å»ºè­°å‡ºç‰Œ";
                        badge.className = "px-3 py-1 text-sm font-bold rounded-full bg-anthropic-green text-white heading-font shadow";
                        vis.className = "flex items-center justify-center w-20 h-28 bg-white rounded-xl shadow border-2 border-anthropic-green text-3xl font-bold font-mono shrink-0";
                    } else {
                        badge.textContent = "âš ï¸ å»ºè­°è“‹ç‰Œ (è¢«è¿«)";
                        badge.className = "px-3 py-1 text-sm font-bold rounded-full bg-anthropic-orange text-white heading-font shadow";
                        vis.className = "flex items-center justify-center w-20 h-28 bg-white opacity-80 rounded-xl shadow border-2 border-anthropic-orange text-3xl font-bold font-mono shrink-0";
                    }

                    suitIcon.innerHTML = suitSymbolSVG[out.suit];
                    rankText.textContent = rankLabels[out.rank] || out.rank;
                    const suitColor = suits.find(s => s.id === out.suit).color;
                    suitIcon.style.color = suitColor;
                    rankText.style.color = suitColor;

                    resOut.classList.add('hidden'); // Hide raw logs

                    // Wire Apply block
                    const applyBtn = document.getElementById('apply-btn');
                    applyBtn.onclick = () => { applySuggestion(out.suit, out.rank, out.is_play); };

                } else if (j.output) {
                    // Fallback for string
                    cardArea.classList.add('hidden');
                    resOut.classList.remove('hidden');
                    resOut.textContent = j.output;
                }
            } catch (e) {
                document.getElementById('suggestion-card-area').classList.add('hidden');
                resOut.classList.remove('hidden');
                resOut.innerHTML = `<span class="text-red-400 font-bold">ğŸš« é€£ç·šå¤±æ•— (${e})</span>`;
            }

            btn.disabled = false;
            btn.innerHTML = 'ğŸš€ é–‹å§‹æ¨æ¼”';
        }

        function applySuggestion(suit, rank, is_play) {
            // 1. Uncheck from hand
            const cb = document.getElementById(`card-${suit}-${rank}`);
            if (cb && cb.checked) {
                cb.checked = false;
            }

            // 2. Adjust board/covers
            if (is_play) {
                const toggle = document.getElementById(`not-started-${suit}`);
                const slider = document.getElementById(`slider-${suit}`);

                if (toggle.checked) {
                    toggle.checked = false;
                    toggle.dispatchEvent(new Event('change'));
                }

                // Expand slider range
                let [low, high] = slider.noUiSlider.get().map(Number);
                if (rank < low) {
                    slider.noUiSlider.set([rank, high]);
                } else if (rank > high) {
                    slider.noUiSlider.set([low, rank]);
                }
            } else {
                // Must be a cover
                const p1cov = document.getElementById('cp1');
                p1cov.value = parseInt(p1cov.value) + 1;
            }

            // Pulse UI indication
            const badge = document.getElementById('suggestion-badge');
            badge.textContent = "å·²å¥—ç”¨æ­¤ç­–ç•¥ï¼";
            document.getElementById('apply-btn').disabled = true;
            document.getElementById('apply-btn').classList.add('opacity-50', 'pointer-events-none');
        }
    </script>
</body>

</html>